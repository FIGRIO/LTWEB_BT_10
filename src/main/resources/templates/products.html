<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Quản lý Sản phẩm</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <h2 class="text-center mb-4">Danh Sách Sản Phẩm</h2>

        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-secondary" onclick="window.location.href='/profile'">Quay lại Profile</button>
            <button class="btn btn-success" id="btnAddProduct" data-bs-toggle="modal"
                data-bs-target="#addProductModal">Thêm Sản Phẩm Mới</button>
        </div>

        <table class="table table-striped table-hover shadow-sm bg-white rounded">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Tên Sản Phẩm</th>
                    <th>Thương Hiệu</th>
                    <th>Xuất Xứ</th>
                    <th>Giá</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Thông Tin Sản Phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="pName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Thương hiệu</label>
                            <input type="text" class="form-control" id="pBrand" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Xuất xứ</label>
                            <input type="text" class="form-control" id="pMadein" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Giá</label>
                            <input type="number" class="form-control" id="pPrice" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Lấy token từ LocalStorage
            var token = localStorage.getItem('jwtToken');

            // Kiểm tra đăng nhập
            if (!token) {
                alert("Vui lòng đăng nhập!");
                window.location.href = '/login-jwt';
                return;
            }

            // 1. Hàm load danh sách sản phẩm từ API
            function loadProducts() {
                $.ajax({
                    url: '/products/all',
                    type: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function (products) {
                        var rows = '';
                        $.each(products, function (index, p) {
                            rows += `<tr>
                                <td>${p.id}</td>
                                <td>${p.name}</td>
                                <td>${p.brand}</td>
                                <td>${p.madein}</td>
                                <td>${p.price}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">Xóa</button>
                                </td>
                            </tr>`;
                        });
                        $('#productTableBody').html(rows);
                    },
                    error: function (xhr) {
                        if (xhr.status === 403) alert("Phiên đăng nhập hết hạn hoặc không đủ quyền truy cập!");
                    }
                });
            }

            // Gọi hàm load ngay khi trang tải xong
            loadProducts();

            // 2. Xử lý sự kiện Submit Form (Thêm sản phẩm)
            $('#addProductForm').submit(function (e) {
                e.preventDefault();
                var product = {
                    name: $('#pName').val(),
                    brand: $('#pBrand').val(),
                    madein: $('#pMadein').val(),
                    price: parseFloat($('#pPrice').val())
                };

                $.ajax({
                    url: '/products/new',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'Authorization': 'Bearer ' + token },
                    data: JSON.stringify(product),
                    success: function (response) {
                        alert("Thêm sản phẩm thành công!");
                        $('#addProductModal').modal('hide'); // Ẩn modal
                        $('#addProductForm')[0].reset(); // Xóa dữ liệu form cũ
                        loadProducts(); // Load lại bảng
                    },
                    error: function (xhr) {
                        if (xhr.status === 403) alert("LỖI: Bạn không có quyền ADMIN để thêm sản phẩm!");
                        else alert("Lỗi khi thêm sản phẩm: " + xhr.status);
                    }
                });
            });

            // 3. Hàm Xóa sản phẩm (Gán vào window để gọi được từ thẻ HTML onclick)
            window.deleteProduct = function (id) {
                if (!confirm("Bạn có chắc muốn xóa sản phẩm ID: " + id + "?")) return;

                $.ajax({
                    url: '/products/delete/' + id,
                    type: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function (response) {
                        alert("Xóa thành công!");
                        loadProducts();
                    },
                    error: function (xhr) {
                        if (xhr.status === 403) alert("LỖI: Chỉ ADMIN mới được xóa sản phẩm!");
                        else alert("Lỗi khi xóa sản phẩm");
                    }
                });
            };
        });
    </script>
</body>

</html>